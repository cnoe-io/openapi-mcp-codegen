# Copyright 2025 CNOE
# SPDX-License-Identifier: Apache-2.0
# Generated by CNOE OpenAPI MCP Codegen tool

"""LangGraph React-agent wrapper for the generated MCP server."""

import asyncio
import importlib.util
import logging
import os
from pathlib import Path
from dotenv import load_dotenv

from datetime import datetime
from langchain_core.tools import tool

from langgraph.prebuilt import create_react_agent
from langgraph.checkpoint.memory import MemorySaver
from langchain_mcp_adapters.client import MultiServerMCPClient
from cnoe_agent_utils import LLMFactory
from langfuse import get_client

load_dotenv()  # makes values from .env available via os.getenv

logger = logging.getLogger(__name__)


# Default system prompt (auto-generated by the generator)
DEFAULT_SYSTEM_PROMPT = r"""You are an expert assistant for the petstore API.
          You can call the following tools:
          - update_pet: Update an existing pet by Id.
- add_pet: Add a new pet to the store. Suggest and check no duplicate pet IDs already in the store.
- find_pets_by_status: Multiple status values can be provided with comma separated strings.
- find_pets_by_tags: Multiple tags can be provided with comma separated strings. Use tag1, tag2, tag3 for testing.
- get_pet_by_id: Returns a single pet.
- update_pet_with_form: Updates a pet resource based on the form data.
- delete_pet: Delete a pet.
- upload_file: Upload image of the pet.
- get_inventory: Returns a map of status codes to quantities.
- place_order: Place a new order in the store.
- get_order_by_id: For valid response try integer IDs with value <= 5 or > 10. Other values will generate exceptions.
- delete_order: For valid response try integer IDs with value < 1000. Anything above 1000 or non-integers will generate API errors.
- create_user: This can only be done by the logged in user.
- create_users_with_list_input: Creates list of users with given input array.
- login_user: Log into the system.
- logout_user: Log user out of the system.
- get_user_by_name: Get user detail based on username.
- update_user: This can only be done by the logged in user.
- delete_user: This can only be done by the logged in user.

          When a tool is appropriate, reply ONLY with the JSON payload;
          otherwise, answer normally."""

# Locate the generated MCP server module
spec = importlib.util.find_spec("mcp_petstore.server")
if not spec or not spec.origin:
    raise ImportError("Cannot find mcp_petstore.server module")
server_path = str(Path(spec.origin).resolve())


@tool
def get_current_time() -> str:
    """Return the current date-time in ISO-8601 format."""
    return datetime.now().isoformat()


async def create_agent(prompt: str | None = None, response_format=None):
    """
    Spin-up the MCP server as a subprocess via MultiServerMCPClient and build
    and returns the LangGraph agent **and its tool list**.
    """
    memory = MemorySaver()

    if prompt is None:
        prompt = DEFAULT_SYSTEM_PROMPT  # ‚Üê use literal string, no fallback

    api_url = os.getenv("PETSTORE_API_URL")
    api_token = os.getenv("PETSTORE_TOKEN")
    if not api_url or not api_token:
        raise ValueError("Set PETSTORE_API_URL and PETSTORE_TOKEN env vars")

    client = MultiServerMCPClient(
        {
            "petstore": {
                "command": "uv",
                "args": ["run", server_path],
                "env": {
                    "PETSTORE_API_URL": api_url,
                    "PETSTORE_TOKEN": api_token,
                },
                "transport": "stdio",
            },
            # Utility MCP
            "unix_timestamps_mcp": {
                "command": "npx",
                "args": ["-y", "github:Ivor/unix-timestamps-mcp"],
                "transport": "stdio",
            },
        }
    )
    mcp_tools = await client.get_tools()
    try:
        get_client().update_current_trace(tags=["petstore-agent"])
    except Exception:
        pass
    tools = mcp_tools + [get_current_time]
    # Attach Langfuse callback handler so LangChain/LLM/tool calls are traced
    try:
        get_client().update_current_trace(tags=["petstore-agent"])
    except Exception:
        pass
    agent = create_react_agent(
        LLMFactory().get_llm(),
        tools=tools,
        checkpointer=memory,
        prompt=prompt,
        response_format=response_format,
    )
    return agent, tools  # also return raw tool list for evaluators


# Convenience synchronous wrapper
def create_agent_sync(prompt: str | None = None, response_format=None):
    agent, tools = asyncio.run(create_agent(prompt, response_format))
    try:
        get_client().flush()
    except Exception:
        pass
    return agent, tools
