# Copyright 2025 CNOE
# SPDX-License-Identifier: Apache-2.0
# Generated by CNOE OpenAPI MCP Codegen tool

"""Tools for /api/v1/applications/{name}/spec operations"""

import logging
from typing import Dict, Any, List
from mcp_argocd.api.client import make_api_request, assemble_nested_body

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("mcp_tools")


async def put_application_svc_upd_spec(
  path_name: str,
  body_destination_name: str = None,
  body_destination_namespace: str = None,
  body_destination_server: str = None,
  body_ignore_differences: List[Dict[str, Any]] = None,
  body_info: List[Dict[str, Any]] = None,
  body_project: str = None,
  body_revision_history_limit: int = None,
  body_source_chart: str = None,
  body_source_directory_exclude: str = None,
  body_source_directory_include: str = None,
  body_source_directory_jsonnet_ext_vars: List[Dict[str, Any]] = None,
  body_source_directory_jsonnet_libs: List[str] = None,
  body_source_directory_jsonnet_tlas: List[Dict[str, Any]] = None,
  body_source_directory_recurse: bool = None,
  body_source_helm: Dict[str, Any] = None,
  body_source_kustomize: Dict[str, Any] = None,
  body_source_name: str = None,
  body_source_path: str = None,
  body_source_plugin_env: List[Dict[str, Any]] = None,
  body_source_plugin_name: str = None,
  body_source_plugin_parameters: List[Dict[str, Any]] = None,
  body_source_ref: str = None,
  body_source_repo_url: str = None,
  body_source_target_revision: str = None,
  body_source_hydrator_dry_source_path: str = None,
  body_source_hydrator_dry_source_repo_url: str = None,
  body_source_hydrator_dry_source_target_revision: str = None,
  body_source_hydrator_hydrate_to_target_branch: str = None,
  body_source_hydrator_sync_source_path: str = None,
  body_source_hydrator_sync_source_target_branch: str = None,
  body_sources: List[Dict[str, Any]] = None,
  body_sync_policy_automated_allow_empty: bool = None,
  body_sync_policy_automated_enabled: bool = None,
  body_sync_policy_automated_prune: bool = None,
  body_sync_policy_automated_self_heal: bool = None,
  body_sync_policy_managed_namespace_metadata_annotations: Dict[str, Any] = None,
  body_sync_policy_managed_namespace_metadata_labels: Dict[str, Any] = None,
  body_sync_policy_retry_backoff_duration: str = None,
  body_sync_policy_retry_backoff_factor: int = None,
  body_sync_policy_retry_backoff_max_duration: str = None,
  body_sync_policy_retry_limit: int = None,
  body_sync_policy_retry_refresh: bool = None,
  body_sync_policy_sync_options: List[str] = None,
  param_validate: bool = False,
  param_app_namespace: str = None,
  param_project: str = None,
) -> Any:
  """
      UpdateSpec updates an application spec

      OpenAPI Description:


      Args:

          path_name (str): OpenAPI parameter corresponding to 'path_name'

          body_destination_name (str): Name is an alternate way of specifying the target cluster by its symbolic name. This must be set if Server is not set.

          body_destination_namespace (str): OpenAPI parameter corresponding to 'body_destination_namespace'

          body_destination_server (str): Server specifies the URL of the target cluster's Kubernetes control plane API. This must be set if Name is not set.

          body_ignore_differences (List[Dict[str, Any]]): OpenAPI parameter corresponding to 'body_ignore_differences'

          body_info (List[Dict[str, Any]]): OpenAPI parameter corresponding to 'body_info'

          body_project (str): Project is a reference to the project this application belongs to.
  The empty string means that application belongs to the 'default' project.

          body_revision_history_limit (int): RevisionHistoryLimit limits the number of items kept in the application's revision history, which is used for informational purposes as well as for rollbacks to previous versions.
  This should only be changed in exceptional circumstances.
  Setting to zero will store no history. This will reduce storage used.
  Increasing will increase the space used to store the history, so we do not recommend increasing it.
  Default is 10.

          body_source_chart (str): Chart is a Helm chart name, and must be specified for applications sourced from a Helm repo.

          body_source_directory_exclude (str): OpenAPI parameter corresponding to 'body_source_directory_exclude'

          body_source_directory_include (str): OpenAPI parameter corresponding to 'body_source_directory_include'

          body_source_directory_jsonnet_ext_vars (List[Dict[str, Any]]): OpenAPI parameter corresponding to 'body_source_directory_jsonnet_ext_vars'

          body_source_directory_jsonnet_libs (List[str]): OpenAPI parameter corresponding to 'body_source_directory_jsonnet_libs'

          body_source_directory_jsonnet_tlas (List[Dict[str, Any]]): OpenAPI parameter corresponding to 'body_source_directory_jsonnet_tlas'

          body_source_directory_recurse (bool): OpenAPI parameter corresponding to 'body_source_directory_recurse'

          body_source_helm (Dict[str, Any]): Request body as dictionary. Contains 15 nested properties. See OpenAPI schema for detailed structure.

          body_source_kustomize (Dict[str, Any]): Request body as dictionary. Contains 18 nested properties. See OpenAPI schema for detailed structure.

          body_source_name (str): Name is used to refer to a source and is displayed in the UI. It is used in multi-source Applications.

          body_source_path (str): Path is a directory path within the Git repository, and is only valid for applications sourced from Git.

          body_source_plugin_env (List[Dict[str, Any]]): OpenAPI parameter corresponding to 'body_source_plugin_env'

          body_source_plugin_name (str): OpenAPI parameter corresponding to 'body_source_plugin_name'

          body_source_plugin_parameters (List[Dict[str, Any]]): OpenAPI parameter corresponding to 'body_source_plugin_parameters'

          body_source_ref (str): Ref is reference to another source within sources field. This field will not be used if used with a `source` tag.

          body_source_repo_url (str): OpenAPI parameter corresponding to 'body_source_repo_url'

          body_source_target_revision (str): TargetRevision defines the revision of the source to sync the application to.
  In case of Git, this can be commit, tag, or branch. If omitted, will equal to HEAD.
  In case of Helm, this is a semver tag for the Chart's version.

          body_source_hydrator_dry_source_path (str): OpenAPI parameter corresponding to 'body_source_hydrator_dry_source_path'

          body_source_hydrator_dry_source_repo_url (str): OpenAPI parameter corresponding to 'body_source_hydrator_dry_source_repo_url'

          body_source_hydrator_dry_source_target_revision (str): OpenAPI parameter corresponding to 'body_source_hydrator_dry_source_target_revision'

          body_source_hydrator_hydrate_to_target_branch (str): OpenAPI parameter corresponding to 'body_source_hydrator_hydrate_to_target_branch'

          body_source_hydrator_sync_source_path (str): Path is a directory path within the git repository where hydrated manifests should be committed to and synced
  from. The Path should never point to the root of the repo. If hydrateTo is set, this is just the path from which
  hydrated manifests will be synced.

  +kubebuilder:validation:Required
  +kubebuilder:validation:MinLength=1
  +kubebuilder:validation:Pattern=`^.{2,}|[^./]$`

          body_source_hydrator_sync_source_target_branch (str): TargetBranch is the branch from which hydrated manifests will be synced.
  If HydrateTo is not set, this is also the branch to which hydrated manifests are committed.

          body_sources (List[Dict[str, Any]]): OpenAPI parameter corresponding to 'body_sources'

          body_sync_policy_automated_allow_empty (bool): OpenAPI parameter corresponding to 'body_sync_policy_automated_allow_empty'

          body_sync_policy_automated_enabled (bool): OpenAPI parameter corresponding to 'body_sync_policy_automated_enabled'

          body_sync_policy_automated_prune (bool): OpenAPI parameter corresponding to 'body_sync_policy_automated_prune'

          body_sync_policy_automated_self_heal (bool): OpenAPI parameter corresponding to 'body_sync_policy_automated_self_heal'

          body_sync_policy_managed_namespace_metadata_annotations (Dict[str, Any]): OpenAPI parameter corresponding to 'body_sync_policy_managed_namespace_metadata_annotations'

          body_sync_policy_managed_namespace_metadata_labels (Dict[str, Any]): OpenAPI parameter corresponding to 'body_sync_policy_managed_namespace_metadata_labels'

          body_sync_policy_retry_backoff_duration (str): OpenAPI parameter corresponding to 'body_sync_policy_retry_backoff_duration'

          body_sync_policy_retry_backoff_factor (int): OpenAPI parameter corresponding to 'body_sync_policy_retry_backoff_factor'

          body_sync_policy_retry_backoff_max_duration (str): OpenAPI parameter corresponding to 'body_sync_policy_retry_backoff_max_duration'

          body_sync_policy_retry_limit (int): Limit is the maximum number of attempts for retrying a failed sync. If set to 0, no retries will be performed.

          body_sync_policy_retry_refresh (bool): OpenAPI parameter corresponding to 'body_sync_policy_retry_refresh'

          body_sync_policy_sync_options (List[str]): OpenAPI parameter corresponding to 'body_sync_policy_sync_options'

          param_validate (bool): OpenAPI parameter corresponding to 'param_validate'

          param_app_namespace (str): OpenAPI parameter corresponding to 'param_app_namespace'

          param_project (str): OpenAPI parameter corresponding to 'param_project'


      Returns:
          Any: The JSON response from the API call.

      Raises:
          Exception: If the API request fails or returns an error.
  """
  logger.debug("Making PUT request to /api/v1/applications/{name}/spec")

  params = {}
  data = {}

  if param_validate is not None:
    params["validate"] = str(param_validate).lower() if isinstance(param_validate, bool) else param_validate

  if param_app_namespace is not None:
    params["app_namespace"] = str(param_app_namespace).lower() if isinstance(param_app_namespace, bool) else param_app_namespace

  if param_project is not None:
    params["project"] = str(param_project).lower() if isinstance(param_project, bool) else param_project

  flat_body = {}
  if body_destination_name is not None:
    flat_body["destination_name"] = body_destination_name
  if body_destination_namespace is not None:
    flat_body["destination_namespace"] = body_destination_namespace
  if body_destination_server is not None:
    flat_body["destination_server"] = body_destination_server
  if body_ignore_differences is not None:
    flat_body["ignore_differences"] = body_ignore_differences
  if body_info is not None:
    flat_body["info"] = body_info
  if body_project is not None:
    flat_body["project"] = body_project
  if body_revision_history_limit is not None:
    flat_body["revision_history_limit"] = body_revision_history_limit
  if body_source_chart is not None:
    flat_body["source_chart"] = body_source_chart
  if body_source_directory_exclude is not None:
    flat_body["source_directory_exclude"] = body_source_directory_exclude
  if body_source_directory_include is not None:
    flat_body["source_directory_include"] = body_source_directory_include
  if body_source_directory_jsonnet_ext_vars is not None:
    flat_body["source_directory_jsonnet_ext_vars"] = body_source_directory_jsonnet_ext_vars
  if body_source_directory_jsonnet_libs is not None:
    flat_body["source_directory_jsonnet_libs"] = body_source_directory_jsonnet_libs
  if body_source_directory_jsonnet_tlas is not None:
    flat_body["source_directory_jsonnet_tlas"] = body_source_directory_jsonnet_tlas
  if body_source_directory_recurse is not None:
    flat_body["source_directory_recurse"] = body_source_directory_recurse
  if body_source_helm is not None:
    flat_body["source_helm"] = body_source_helm
  if body_source_kustomize is not None:
    flat_body["source_kustomize"] = body_source_kustomize
  if body_source_name is not None:
    flat_body["source_name"] = body_source_name
  if body_source_path is not None:
    flat_body["source_path"] = body_source_path
  if body_source_plugin_env is not None:
    flat_body["source_plugin_env"] = body_source_plugin_env
  if body_source_plugin_name is not None:
    flat_body["source_plugin_name"] = body_source_plugin_name
  if body_source_plugin_parameters is not None:
    flat_body["source_plugin_parameters"] = body_source_plugin_parameters
  if body_source_ref is not None:
    flat_body["source_ref"] = body_source_ref
  if body_source_repo_url is not None:
    flat_body["source_repo_url"] = body_source_repo_url
  if body_source_target_revision is not None:
    flat_body["source_target_revision"] = body_source_target_revision
  if body_source_hydrator_dry_source_path is not None:
    flat_body["source_hydrator_dry_source_path"] = body_source_hydrator_dry_source_path
  if body_source_hydrator_dry_source_repo_url is not None:
    flat_body["source_hydrator_dry_source_repo_url"] = body_source_hydrator_dry_source_repo_url
  if body_source_hydrator_dry_source_target_revision is not None:
    flat_body["source_hydrator_dry_source_target_revision"] = body_source_hydrator_dry_source_target_revision
  if body_source_hydrator_hydrate_to_target_branch is not None:
    flat_body["source_hydrator_hydrate_to_target_branch"] = body_source_hydrator_hydrate_to_target_branch
  if body_source_hydrator_sync_source_path is not None:
    flat_body["source_hydrator_sync_source_path"] = body_source_hydrator_sync_source_path
  if body_source_hydrator_sync_source_target_branch is not None:
    flat_body["source_hydrator_sync_source_target_branch"] = body_source_hydrator_sync_source_target_branch
  if body_sources is not None:
    flat_body["sources"] = body_sources
  if body_sync_policy_automated_allow_empty is not None:
    flat_body["sync_policy_automated_allow_empty"] = body_sync_policy_automated_allow_empty
  if body_sync_policy_automated_enabled is not None:
    flat_body["sync_policy_automated_enabled"] = body_sync_policy_automated_enabled
  if body_sync_policy_automated_prune is not None:
    flat_body["sync_policy_automated_prune"] = body_sync_policy_automated_prune
  if body_sync_policy_automated_self_heal is not None:
    flat_body["sync_policy_automated_self_heal"] = body_sync_policy_automated_self_heal
  if body_sync_policy_managed_namespace_metadata_annotations is not None:
    flat_body["sync_policy_managed_namespace_metadata_annotations"] = body_sync_policy_managed_namespace_metadata_annotations
  if body_sync_policy_managed_namespace_metadata_labels is not None:
    flat_body["sync_policy_managed_namespace_metadata_labels"] = body_sync_policy_managed_namespace_metadata_labels
  if body_sync_policy_retry_backoff_duration is not None:
    flat_body["sync_policy_retry_backoff_duration"] = body_sync_policy_retry_backoff_duration
  if body_sync_policy_retry_backoff_factor is not None:
    flat_body["sync_policy_retry_backoff_factor"] = body_sync_policy_retry_backoff_factor
  if body_sync_policy_retry_backoff_max_duration is not None:
    flat_body["sync_policy_retry_backoff_max_duration"] = body_sync_policy_retry_backoff_max_duration
  if body_sync_policy_retry_limit is not None:
    flat_body["sync_policy_retry_limit"] = body_sync_policy_retry_limit
  if body_sync_policy_retry_refresh is not None:
    flat_body["sync_policy_retry_refresh"] = body_sync_policy_retry_refresh
  if body_sync_policy_sync_options is not None:
    flat_body["sync_policy_sync_options"] = body_sync_policy_sync_options
  data = assemble_nested_body(flat_body)

  success, response = await make_api_request(f"/api/v1/applications/{path_name}/spec", method="PUT", params=params, data=data)

  if not success:
    logger.error(f"Request failed: {response.get('error')}")
    return {"error": response.get("error", "Request failed")}
  return response
