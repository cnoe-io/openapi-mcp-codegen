# Copyright 2025 CNOE
# SPDX-License-Identifier: Apache-2.0
# Generated by CNOE OpenAPI MCP Codegen tool

"""LangGraph React-agent wrapper for the generated MCP server."""

import asyncio
import importlib.util
import logging
import os
from pathlib import Path
from dotenv import load_dotenv

from datetime import datetime, timezone
from langchain_core.tools import tool

from langgraph.prebuilt import create_react_agent
from langgraph.checkpoint.memory import MemorySaver
from langchain_mcp_adapters.client import MultiServerMCPClient
from cnoe_agent_utils import LLMFactory
from langfuse import get_client

load_dotenv()  # makes values from .env available via os.getenv

logger = logging.getLogger(__name__)


# Default system prompt (auto-generated by the generator)
DEFAULT_SYSTEM_PROMPT = r"""You are an expert assistant for the argo_workflows API.
          You can call the following tools:
          - archived_workflow_service_list_archived_workflows: List or query archived-workflows Use when: when you need to discover available resources or check what exists
- archived_workflow_service_list_archived_workflow_label_keys: List or query archived-workflows-label-keys Use when: when you need to discover available resources or check what exists
- archived_workflow_service_list_archived_workflow_label_values: List or query archived-workflows-label-values Use when: when you need to discover available resources or check what exists
- archived_workflow_service_get_archived_workflow: Retrieve details of a specific archived-workflows Use when: when you have a specific resource identifier and need its current details. Required: uid
- archived_workflow_service_delete_archived_workflow: Delete a archived-workflows Use when: when cleaning up resources that are no longer needed. Required: uid
- archived_workflow_service_resubmit_archived_workflow: Update or replace a resubmit Use when: when modifying existing resource configurations or properties. Required: uid, body
- archived_workflow_service_retry_archived_workflow: Update or replace a retry Use when: when modifying existing resource configurations or properties. Required: uid, body
- cluster_workflow_template_service_list_cluster_workflow_templates: List or query cluster-workflow-templates Use when: when you need to discover available resources or check what exists
- cluster_workflow_template_service_create_cluster_workflow_template: Create a new cluster-workflow-templates Use when: when initializing new resources based on user requirements. Required: body
- cluster_workflow_template_service_lint_cluster_workflow_template: Perform an operation on lint Use when: when initializing new resources based on user requirements. Required: body
- cluster_workflow_template_service_get_cluster_workflow_template: Retrieve details of a specific cluster-workflow-templates Use when: when you have a specific resource identifier and need its current details. Required: name
- cluster_workflow_template_service_update_cluster_workflow_template: Update or replace a cluster-workflow-templates Use when: when modifying existing resource configurations or properties. Required: name, body
- cluster_workflow_template_service_delete_cluster_workflow_template: Delete a cluster-workflow-templates Use when: when cleaning up resources that are no longer needed. Required: name
- cron_workflow_service_list_cron_workflows: Retrieve details of a specific cron-workflows Use when: when you need to discover available resources or check what exists. Required: namespace
- cron_workflow_service_create_cron_workflow: Create a new cron-workflows Use when: when initializing new resources based on user requirements. Required: namespace, body
- cron_workflow_service_lint_cron_workflow: Perform an operation on lint Use when: when initializing new resources based on user requirements. Required: namespace, body
- cron_workflow_service_get_cron_workflow: Retrieve cron-workflows information Use when: when you have a specific resource identifier and need its current details. Required: namespace, name
- cron_workflow_service_update_cron_workflow: Update or replace a cron-workflows Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- cron_workflow_service_delete_cron_workflow: Delete a cron-workflows Use when: when cleaning up resources that are no longer needed. Required: namespace, name
- cron_workflow_service_resume_cron_workflow: Update or replace a resume Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- cron_workflow_service_suspend_cron_workflow: Update or replace a suspend Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- event_source_service_list_event_sources: Retrieve details of a specific event-sources Use when: when you need to discover available resources or check what exists. Required: namespace
- event_source_service_create_event_source: Create a new event-sources Use when: when initializing new resources based on user requirements. Required: namespace, body
- event_source_service_get_event_source: Retrieve event-sources information Use when: when you have a specific resource identifier and need its current details. Required: namespace, name
- event_source_service_update_event_source: Update or replace a event-sources Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- event_source_service_delete_event_source: Delete a event-sources Use when: when cleaning up resources that are no longer needed. Required: namespace, name
- event_service_receive_event: Perform an operation on events Use when: when initializing new resources based on user requirements. Required: namespace, discriminator, body
- info_service_get_info: List or query info
- sensor_service_list_sensors: Retrieve details of a specific sensors Use when: when you need to discover available resources or check what exists. Required: namespace
- sensor_service_create_sensor: Create a new sensors Use when: when initializing new resources based on user requirements. Required: namespace, body
- sensor_service_get_sensor: Retrieve sensors information Use when: when you have a specific resource identifier and need its current details. Required: namespace, name
- sensor_service_update_sensor: Update or replace a sensors Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- sensor_service_delete_sensor: Delete a sensors Use when: when cleaning up resources that are no longer needed. Required: namespace, name
- event_source_service_watch_event_sources: Retrieve details of a specific event-sources. Required: namespace
- event_source_service_event_sources_logs: Retrieve details of a specific logs Use when: for debugging issues or understanding resource behavior. Required: namespace
- workflow_service_watch_events: Retrieve details of a specific events. Required: namespace
- sensor_service_watch_sensors: Retrieve details of a specific sensors. Required: namespace
- sensor_service_sensors_logs: Retrieve details of a specific logs Use when: for debugging issues or understanding resource behavior. Required: namespace
- info_service_collect_event: Perform an operation on event Use when: when initializing new resources based on user requirements. Required: body
- info_service_get_user_info: List or query userinfo
- info_service_get_version: List or query version
- event_service_list_workflow_event_bindings: Retrieve details of a specific workflow-event-bindings Use when: when you need to discover available resources or check what exists. Required: namespace
- workflow_service_watch_workflows: Retrieve details of a specific workflow-events. Required: namespace
- workflow_template_service_list_workflow_templates: Retrieve details of a specific workflow-templates Use when: when you need to discover available resources or check what exists. Required: namespace
- workflow_template_service_create_workflow_template: Create a new workflow-templates Use when: when initializing new resources based on user requirements. Required: namespace, body
- workflow_template_service_lint_workflow_template: Perform an operation on lint Use when: when initializing new resources based on user requirements. Required: namespace, body
- workflow_template_service_get_workflow_template: Retrieve workflow-templates information Use when: when you have a specific resource identifier and need its current details. Required: namespace, name
- workflow_template_service_update_workflow_template: Update or replace a workflow-templates Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- workflow_template_service_delete_workflow_template: Delete a workflow-templates Use when: when cleaning up resources that are no longer needed. Required: namespace, name
- workflow_service_list_workflows: Retrieve details of a specific workflows Use when: when you need to discover available resources or check what exists. Required: namespace
- workflow_service_create_workflow: Create a new workflows Use when: when initializing new resources based on user requirements. Required: namespace, body
- workflow_service_lint_workflow: Perform an operation on lint Use when: when initializing new resources based on user requirements. Required: namespace, body
- workflow_service_submit_workflow: Perform an operation on submit Use when: when initializing new resources based on user requirements. Required: namespace, body
- workflow_service_get_workflow: Retrieve workflows information Use when: when you have a specific resource identifier and need its current details. Required: namespace, name
- workflow_service_delete_workflow: Delete a workflows Use when: when cleaning up resources that are no longer needed. Required: namespace, name
- workflow_service_workflow_logs: Retrieve log information Use when: for debugging issues or understanding resource behavior. Required: namespace, name
- workflow_service_resubmit_workflow: Update or replace a resubmit Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- workflow_service_resume_workflow: Update or replace a resume Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- workflow_service_retry_workflow: Update or replace a retry Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- workflow_service_set_workflow: Update or replace a set Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- workflow_service_stop_workflow: Update or replace a stop Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- workflow_service_suspend_workflow: Update or replace a suspend Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- workflow_service_terminate_workflow: Update or replace a terminate Use when: when modifying existing resource configurations or properties. Required: namespace, name, body
- workflow_service_pod_logs: Retrieve log information Use when: for debugging issues or understanding resource behavior. Required: namespace, name, podName
- artifact_service_get_artifact_file: Retrieve artifact-files information Use when: when you have a specific resource identifier and need its current details
- artifact_service_get_output_artifact_by_uid: Retrieve artifacts-by-uid information Use when: when you have a specific resource identifier and need its current details. Required: uid, nodeId, artifactName
- artifact_service_get_output_artifact: Retrieve artifacts information Use when: when you have a specific resource identifier and need its current details
- artifact_service_get_input_artifact_by_uid: Retrieve input-artifacts-by-uid information Use when: when you have a specific resource identifier and need its current details. Required: uid, nodeId, artifactName
- artifact_service_get_input_artifact: Retrieve input-artifacts information Use when: when you have a specific resource identifier and need its current details

          When a tool is appropriate, reply ONLY with the JSON payload;
          otherwise, answer normally."""

# Locate the generated MCP server module
spec = importlib.util.find_spec("mcp_argo_workflows.server")
if not spec or not spec.origin:
    raise ImportError("Cannot find mcp_argo_workflows.server module")
server_path = str(Path(spec.origin).resolve())


@tool
def get_current_time() -> str:
    """Return the current date-time in ISO-8601 format."""
    return datetime.now().isoformat()


@tool
def iso8601_to_unix(iso_str: str) -> str:
    """
    Convert an ISO-8601 datetime string to a Unix timestamp (seconds since epoch).
    If no timezone is present, assume UTC.
    """
    s = iso_str.strip()
    # Support common variations: with/without 'Z', with offset, with space instead of 'T'
    # Normalize space to 'T' to help fromisoformat
    if " " in s and "T" not in s:
        s = s.replace(" ", "T")

    # Handle trailing 'Z' (UTC)
    if s.endswith("Z"):
        s = s[:-1] + "+00:00"

    try:
        dt = datetime.fromisoformat(s)
    except ValueError:
        # Fallback: try parsing without separators or with milliseconds
        raise ValueError(f"Invalid ISO-8601 datetime string: {iso_str}")

    if dt.tzinfo is None:
        dt = dt.replace(tzinfo=timezone.utc)

    return str(int(dt.timestamp()))


async def create_agent(prompt: str | None = None, response_format=None):
    """
    Spin-up the MCP server as a subprocess via MultiServerMCPClient and build
    and returns the LangGraph agent **and its tool list**.
    """
    memory = MemorySaver()

    if prompt is None:
        prompt = DEFAULT_SYSTEM_PROMPT  # ‚Üê use literal string, no fallback

    api_url = os.getenv("ARGO_WORKFLOWS_API_URL")
    api_token = os.getenv("ARGO_WORKFLOWS_TOKEN")
    if not api_url or not api_token:
        raise ValueError("Set ARGO_WORKFLOWS_API_URL and ARGO_WORKFLOWS_TOKEN env vars")

    client = MultiServerMCPClient(
        {
            "argo_workflows": {
                "command": "uv",
                "args": ["run", server_path],
                "env": {
                    "ARGO_WORKFLOWS_API_URL": api_url,
                    "ARGO_WORKFLOWS_TOKEN": api_token,
                },
                "transport": "stdio",
            }
        }
    )
    mcp_tools = await client.get_tools()
    try:
        get_client().update_current_trace(tags=["argo_workflows-agent"])
    except Exception:
        pass
    tools = mcp_tools + [get_current_time, iso8601_to_unix]
    # Attach Langfuse callback handler so LangChain/LLM/tool calls are traced
    try:
        get_client().update_current_trace(tags=["argo_workflows-agent"])
    except Exception:
        pass
    agent = create_react_agent(
        LLMFactory().get_llm(),
        tools=tools,
        checkpointer=memory,
        prompt=prompt,
        response_format=response_format,
    )
    return agent, tools  # also return raw tool list for evaluators


# Convenience synchronous wrapper
def create_agent_sync(prompt: str | None = None, response_format=None):
    agent, tools = asyncio.run(create_agent(prompt, response_format))
    try:
        get_client().flush()
    except Exception:
        pass
    return agent, tools
